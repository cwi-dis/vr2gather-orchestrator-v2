<!DOCTYPE html>
<html>
  <head>
    <title>VR2Gather Orchestrator Admin Interface</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css" />

    <style>
      #log {
        height: 400px;
        overflow-y: auto;
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
      }
    </style>

    <script type="text/javascript" src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script type="text/javascript">
      class RingBuffer {
        constructor(size) {
          this.size = size;
          this.buffer = [];
        }

        add(item) {
          if (this.buffer.length >= this.size) {
            this.buffer.shift();
          }
          this.buffer.push(item);
        }

        get() {
          return this.buffer;
        }
      }

      function removeAnsiColorCodes(str) {
        return str.replace(/\x1B\[[0-9;]*m/g, '');
      }

      document.addEventListener("DOMContentLoaded", () => {
        const utilSocket = io();

        const tree = document.querySelector("#tree");
        const lastUpdate = document.querySelector("#last-update");
        const relaunchBtn = document.querySelector("#relaunch-btn");

        const fetchTree = () => {
          utilSocket.emit("DumpData", {}, (data) => {
            const { message, body } = data;

            if (message == "OK") {
              tree.innerHTML = `<pre>${JSON.stringify(body, null, 2)}</pre>`
              lastUpdate.textContent = new Date().toLocaleString();
            }
          });
        };

        utilSocket.on("connect", () => {
          console.log("Util socket connected");

          if (tree && lastUpdate && relaunchBtn) {
            relaunchBtn.disabled = false;

            const treeInterval = setInterval(fetchTree, 5000);
            fetchTree();

            relaunchBtn.addEventListener("click", () => {
              if (window.confirm("Are you sure you want to relaunch the Orchestrator? All current data will be lost.")) {
                utilSocket.emit("TerminateOrchestrator", () => {
                  clearInterval(treeInterval);
                  relaunchBtn.disabled = true;

                  lastUpdate.textContent = "";
                  lastUpdate.parentElement.hidden = true;

                  tree.innerHTML = "<div class=\"notification is-warning\">Orchestrator is being relaunched. Please wait a few seconds for the page to reload...</div>";

                  setTimeout(() => {
                    window.location.reload();
                  }, 5000);
                });
              }
            });
          }
        });

        const logSocket = io("/log");
        const logContainer = document.querySelector("#log");

        logSocket.on("connect", () => {
          if (logContainer) {
            const logBuffer = new RingBuffer(100);

            logSocket.on("message", ({ timestamp, level, message}) => {
              logBuffer.add({ timestamp, level, message});

              logContainer.innerHTML = logBuffer.get().map(log => {
                return `<p class="is-family-monospace">${log.timestamp} ${removeAnsiColorCodes(log.level)}: ${log.message}</p>`;
              }).join("");

              logContainer.scrollTop = logContainer.scrollHeight;
            });
          }
        });
      });
    </script>
  </head>
  <body>
    <div class="container">
      <section class="section">
        <h1 class="title is-3">VR2Gather Orchestrator Admin Interface</h1>
        <h2 class="subtitle is-4">Version: <%= orchestrator_version %></h2>

        <div class="block">
          <h2 class="title is-4">State tree</h2>
          <p>Last Update: <span id="last-update"></span></p>
          <div id="tree" class="block"></div>
        </div>

        <div class="block">
          <h2 class="title is-4">Debug Log</h2>
          <div id="log" class="block"></div>
        </div>

        <div class="block">
          <button id="relaunch-btn" class="button is-link" disabled>Relaunch Orchestrator</button>
        </div>
      </div>
    </section>
  </body>
</html>
